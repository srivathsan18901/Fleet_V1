<div class="layout-container">
  <app-fullscreen-button></app-fullscreen-button>
  <app-loader></app-loader>
  <div class="content-container">
    <div class="main-content">
      <!-- Header section -->
      <div class="header-section">
        <h1 class="header-title">{{ getTranslation("Tasks")}}</h1>
        <div class="subheader-container">
          <div class="subheader-text">{{ getTranslation("View and Edit Tasks")}}</div>
          <img
            src="../../assets/icons/i-icon.svg"
            alt="Icon"
            class="subheader-icon"
          />
        </div>
      </div>
      <!-- search container -->
      <div class="search-filter-container" >
        <!-- Search Bar -->
        <div class="search-box">
          <input type="text" (input)="onSearch($event)" placeholder="{{ getTranslation('Search For Tasks...') }}" [value]="searchQuery"/>
          <button class="search-btn">
            <img
              src="../../assets/icons/download-removebg-preview.png"
              alt="Search"
            />
          </button>
        </div>

      </div>
      <div *ngIf="isButtonDisabled" class="AT-CLS">
        <button class="AT-Btn" (click)="toggleAssignTask()">
          <div class="svg-wrapper-1">
            <div class="svg-wrapper">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                <path fill="none" d="M0 0h24v24H0z"></path>
                <path fill="currentColor" d="M1.946 9.315c-.522-.174-.527-.455.01-.634l19.087-6.362c.529-.176.832.12.684.638l-5.454 19.086c-.15.529-.455.547-.679.045L12 14l6-8-8 6-8.054-2.685z"></path>
              </svg>
            </div>
          </div>
          <span>{{getTranslation("assign_task")}}</span>
        </button>     
       </div>
      <div style="display: flex ; position: absolute; gap: 10px; top: 150px; right: 45px;">
        <div style="position: relative;">
          <div style="display: flex; position: absolute; gap: 10px; top: -15px; right: -25px;; border-radius: 10px; padding: 10px; background-color: #f7f7f7; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
            <button (click)="openFilterPopup()" class="filter-btn">
              <img src="../../assets/filter.svg" class="filter-img">
              {{ getTranslation('Filter') }}
            </button>
            <button (click)="clearFilters()" class="clr-fil-btn">{{ getTranslation('Clear') }}</button>
          </div>
          <div *ngIf="isFilterPopupVisible" class="filter-popup">
            <div class="filter-content">
              <div style="display: flex ; align-items: center; justify-content: space-between;">
              <h3 style="margin: 0;font-weight: bold;color: #FF5C5C;">{{ getTranslation('filter_options') }}</h3>
              <button class="close-btn" (click)="closeFilterPopup()" style=" color: red;font-weight:bold ;padding: 5px 8px; border-radius: 50%;">âœ–</button>
              </div>
              <!-- Date Range Filter -->
              <div style="display: flex;gap: 15px;">
              <div>
              <label style="font-size: 12px; font-weight:bold ; color: #FF5C5C;">{{ getTranslation('start_date_time') }}:</label>
              <input type="datetime-local" [(ngModel)]="filterOptions.startDateTime" [min]="getMinDate()" [max]="getMaxDate()" style="border: 1px solid;color: #FF5C5C; padding: 5px; border-radius: 5px;">
              </div>
              <div>
              <label style="font-size: 12px; font-weight:bold ; color: #FF5C5C;">{{ getTranslation('end_date_time') }}:</label>
              <input type="datetime-local" [(ngModel)]="filterOptions.endDateTime"  [min]="getMinDate()" [max]="getMaxDate()" style="border: 1px solid;color: #FF5C5C; padding: 5px; border-radius: 5px;">
              </div>
              </div>
            <div style="display: flex; gap: 15px;">
              <!-- Status Filter -->
              <div style="display: flex;justify-content: space-between;align-items: start; flex-direction: column;">
              <label style="font-size: 12px; font-weight:bold ; color: #FF5C5C;">{{ getTranslation('status') }}:</label>
              <select [(ngModel)]="filterOptions.status" style="border: 1px solid #ff5c5c; width: 163px; border-radius: 5px; color: #FF5C5C;padding: 5px;">
                <option value="">{{ getTranslation('All') }}</option>
                <option value="COMPLETED">{{ getTranslation('Completed') }}</option>
                <option value="INPROGRESS">{{ getTranslation('In Progress') }}</option>
                <option value="CANCELLED">{{ getTranslation('Cancelled') }}</option>
                <option value="FAILED">{{ getTranslation('Failed') }}</option>
                <option value="NOTASSIGNED">{{ getTranslation('Not Assigned') }}</option>
                <option value="ASSIGNED">{{ getTranslation('Assigned') }}</option>
              </select>
             </div>
             <!-- Robot ID Filter -->
             <div style="display: flex;justify-content: space-between;align-items: start; flex-direction: column;">
              <label style="font-size: 12px; font-weight:bold ; color: #FF5C5C;">{{ getTranslation('robot_id') }}:</label>
              <select [(ngModel)]="filterOptions.robotId" style="border: 1px solid #ff5c5c; width: 163px; border-radius: 5px; color: #FF5C5C;padding: 5px;">
                <option value="">{{ getTranslation('All') }}</option>
                <option *ngFor="let robotId of robotList" [value]="robotId">
                  {{ robotId }}
                </option>
              </select>
            </div>
            </div>
              <!-- Buttons -->
              <div class="filter-actions">
                <button style="    background: #ff5c5c; color: white; border-radius: 5px; padding: 5px;" (click)="applyFilters()">{{ getTranslation('apply') }}</button>
                <button style="    background: #ff5c5c; color: white; border-radius: 5px; padding: 5px;" (click)="clearFilters()">{{ getTranslation('Clear') }}</button>
              </div>
            </div>
          </div>
        </div>
    </div>
      <!-- Table -->
      <div class="table-container">
        <div class="table-wrapper">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>{{ getTranslation('S.no') }}</th>
                  <th>{{ getTranslation('Date and time') }}</th>
                  <th>{{ getTranslation('Task ID') }}</th>
                  <th>{{ getTranslation('Task Type') }}</th>
                  <th>{{ getTranslation('Status') }}</th>
                  <th>{{ getTranslation('Robot ID') }}</th>
                  <th>{{ getTranslation('Destination') }}</th>                  
                  <th>{{ getTranslation('assign_robots') }}</th>   
                  <th>{{ getTranslation('Actions') }}</th>
                </tr>
              </thead>
            </table>
          </div>
      
          <div class="table-body">
            <table class="table">
              <tbody>
                <!-- Loader shown only during the initial load -->
                <!-- <tr *ngIf="!isLoading && isFirstLoad"> -->
                <tr *ngIf="isFleetMode == true && isFirstLoad && paginatedData.length >= 1">
                  <div >
                    <ngx-spinner class="spinner" bdColor = "rgba(0, 0, 0, 0)" size = "default" color = "red" type = "ball-spin" [fullScreen] = "false">
                    </ngx-spinner>
                  </div>
                </tr>
              
                <!-- Show No Data Row -->
                <tr *ngIf="paginatedData.length === 0 || isLoading == false ">
                  <td colspan="8" class="no-data">
                    <div class="no-data-container">
                      <img src="../assets/no-data.svg" alt="No Data" class="no-data-image" />
                      <p class="no-data-text">{{ nodata }}</p>
                    </div>
                  </td>
                </tr>

              
                <!-- Display data rows -->

                <ng-container *ngFor="let item of paginatedData; index as i; trackBy: trackByTaskId">
                  <tr [class.paused]="item.paused">
                    <td>{{ item.sNo }}</td>
                    <td>{{ item.TimeStamp }}</td>
                    <td>{{ item.taskId }}</td>
                    <td>{{ getTranslation(item.taskType) }}</td>
                    <td>{{ getTranslation(item.status) }}</td>
                    <td>{{ item.robotID < 0 ? "--" : item.robotID }}</td>
                    <td>{{ item.destinationLocation }}</td>
                    <td>
                      <div style="display: flex; align-items: center; gap: 10px;">
                        <ng-container *ngIf="item.status === 'NOTASSIGNED'; else assigned">
                          <button *ngIf="!item.showDropdown" [disabled]="dropdownLocked" (click)="toggleDropdown(item)" class="Assibtn-common Assibtn-cancel">
                            {{ getTranslation('assign') }}
                          </button>
                          <ng-container *ngIf="item.showDropdown">
                            <select [(ngModel)]="item.selectedRobot" style="height: 20px; border-bottom: 1px solid; background: transparent; border-radius: 5px;">
                              <option value="" disabled selected>{{ getTranslation('select') }}</option>
                              <option *ngFor="let robot of robotList" [value]="robot">{{ robot }}</option>
                            </select>
                            <div class="icon-buttons">
                              <!-- Confirm Button -->
                              <button
                                *ngIf="item.selectedRobot"
                                (click)="assignRobot(item)"
                                class="icon-btn confirm"
                                pTooltip="Confirm"
                                tooltipPosition="top"
                                aria-label="Confirm assignment"
                                tabindex="0"
                                (keyup.enter)="assignRobot(item)"
                              >
                                <i class="pi pi-check"></i>
                              </button>
                            
                              <!-- Cancel Button -->
                              <button
                                (click)="cancelAssign(item)"
                                class="icon-btn cancel"
                                pTooltip="Cancel"
                                tooltipPosition="top"
                                aria-label="Cancel assignment"
                                tabindex="0"
                                (keyup.enter)="cancelAssign(item)"
                              >
                                <i class="pi pi-times"></i>
                              </button>
                            </div>
                            
                            
                          </ng-container>
                        </ng-container>
                        <ng-template #assigned>
                          <ng-container *ngIf="item.status === 'ASSIGNED' || item.status === 'INPROGRESS'  || item.status === 'ACCEPTED' ; else inProgress">
                            <button  *ngIf="!item.showReassDropdown" [disabled]="dropdownLocked" (click)="reassignRobot(item)" class="Assibtn-common Assibtn-cancel">
                              {{ getTranslation('re_assign') }}
                            </button>
                            <ng-container *ngIf="item.showReassDropdown">
                              <select [(ngModel)]="item.selectedRobot" style="height: 20px; border-bottom: 1px solid; background: transparent; border-radius: 5px;">
                                <option value="" disabled selected>{{ getTranslation('select') }}</option>
                                <option *ngFor="let robot of robotList" [value]="robot">{{ robot }}</option>
                              </select>
                              <div>
                                <!-- Confirm icon (check) -->
                                <button *ngIf="item.selectedRobot" (click)="assignRobot(item)" class="Assibtn-common Assibtn-cancel" title="Confirm">
                                  <i class="pi pi-check"></i>
                                </button>
                                <!-- Cancel icon (close) -->
                                <button (click)="cancelAssign(item)" class="btn-common btn-cancel" title="Cancel">
                                  <i class="pi pi-times"></i>
                                </button>
                              </div>
                            </ng-container>
                          </ng-container>
                        </ng-template>
                        <ng-template #inProgress>
                          <span>{{ item.status }}</span>
                        </ng-template>
                      </div>
                    </td>
                    <td>
                      <div class="switch-container">
                        <button
                          [ngClass]="{'btn-disabled': isDisabled(item.status), 'btn-cancel': !isDisabled(item.status)}"
                          [disabled]="isDisabled(item.status)"
                          class="btn-common"
                          (click)="!isDisabled(item.status) && onCancel(item)">
                          {{ getTranslation('Cancel') }}
                        </button>  
                        <button class="arrow-btn" (click)="toggleDetails(item)">
                          <svg *ngIf="expandedRowMap[item.taskId]" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="18 15 12 9 6 15"></polyline> <!-- Up Arrow -->
                          </svg>
                          <svg *ngIf="!expandedRowMap[item.taskId]" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline> <!-- Down Arrow -->
                          </svg>
                        </button>
                                     
                      </div>
                    </td>        
                  </tr>
                  <tr *ngIf="expandedRowMap[item.taskId]">
                    <td colspan="9" class="expanded-row">
                      <div class="card bg-white justify-content-center p-3">
                        <div class="progress-container">
                          <div *ngFor="let step of getSteps(item); let i = index" class="step"> 
                            <div class="circle-container">
                              <div
                                class="circle"
                                [ngClass]="{
                                  'completed': i < getCurrentStep(item),
                                  'in-progress': i === getCurrentStep(item),
                                  'pending': i > getCurrentStep(item)
                                }"
                              >
                                <img *ngIf="step.icon" [src]="step.icon" alt="{{ step.label }}" class="icon-img" />
                              </div>
                              <span class="step-label">{{ step.label }}</span>
                            </div>
                            <!-- Line only between circles -->
                            <div *ngIf="i < getSteps(item).length - 1" class="line" [ngClass]="{'active': i < getCurrentStep(item)}"></div>
                          </div>
                        </div>
                      </div>
                    </td>
                  </tr>                
                </ng-container>
              </tbody>
              
            </table>
          </div>
        </div>
      </div>
      
              <!-- Paginator -->
          <div  class="paginator-container" *ngIf="filteredTaskData.length > 0 && !isLoading" >
            <mat-paginator
              [length]="filteredTaskData.length"
              [pageSize]="5"
              [pageSizeOptions]="[5, 10]"
              (page)="onPageChange($event)"
              showFirstLastButtons
            >
            </mat-paginator>
          </div>
      
      <!-- Export -->
      <div class="export-button-container">
        <button class="export-button" (click)="showPopup()">{{ getTranslation('Export') }}</button>
        <div *ngIf="isPopupVisible" class="export-popup">
          <div class="popup-content">
            <button class="close-button" (click)="onClose()">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                width="24"
                height="24"
              >
                <path fill="none" d="M0 0h24v24H0z" />
                <path
                  d="M12 10.586l4.95-4.95 1.414 1.414L13.414 12l4.95 4.95-1.414 1.414L12 13.414l-4.95 4.95-1.414-1.414L10.586 12 5.636 7.05l1.414-1.414L12 10.586z"
                />
              </svg>
            </button>
            <h3>{{ getTranslation('Select Format') }}</h3>
            <div class="button-container">
              <button (click)="exportData('csv')">{{ getTranslation('Export as CSV') }}</button>
              <button (click)="exportData('excel')">{{ getTranslation('Export as Excel') }}</button>
              <!-- <button (click)="exportData('pdf')">Export as PDF</button> -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>